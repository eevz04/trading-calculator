<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‚ö° Trading R√°pido - Formulario</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(45deg, #FF6B6B, #4ECDC4);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }
        
        .form-section {
            padding: 30px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 40px;
            align-items: start;
        }
        
        .column-left {
            display: flex;
            flex-direction: column;
            gap: 25px;
        }
        
        .column-right {
            display: flex;
            flex-direction: column;
            gap: 25px;
        }
        
        @media (max-width: 968px) {
            .form-section {
                grid-template-columns: 1fr;
                gap: 30px;
            }
        }
        
        .section-title {
            font-size: 1.2rem;
            color: #333;
            margin-bottom: 15px;
            padding-bottom: 8px;
            border-bottom: 3px solid #4ECDC4;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
        }
        
        .form-group label {
            font-weight: 600;
            color: #555;
            margin-bottom: 6px;
            font-size: 0.9rem;
        }
        
        .form-group input, .form-group select {
            padding: 10px 12px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 0.95rem;
            transition: all 0.3s ease;
        }
        
        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #4ECDC4;
            box-shadow: 0 0 0 3px rgba(78, 205, 196, 0.1);
        }
        
        .entradas-container {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 12px;
        }
        
        .entrada-item {
            display: grid;
            grid-template-columns: 1fr 80px;
            gap: 12px;
            margin-bottom: 12px;
            align-items: end;
        }
        
        .escalada-container {
            background: #fff3cd;
            padding: 20px;
            border-radius: 12px;
        }
        
        .escalada-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-top: 15px;
        }
        
        .escalada-grid-bottom {
            display: grid;
            grid-template-columns: 80px 80px;
            gap: 12px;
            margin-top: 12px;
        }
        
        .parser-section {
            background: #e7f3ff;
            padding: 20px;
            border-radius: 12px;
        }
        
        .parser-textarea {
            width: 100%;
            min-height: 120px;
            padding: 15px;
            border: 2px solid #0084ff;
            border-radius: 8px;
            font-family: monospace;
            font-size: 0.85rem;
            resize: vertical;
            margin-bottom: 10px;
        }
        
        .buttons-container {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }
        
        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 25px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .btn-primary {
            background: linear-gradient(45deg, #4ECDC4, #44A08D);
            color: white;
        }
        
        .btn-secondary {
            background: linear-gradient(45deg, #FF6B6B, #FF8E53);
            color: white;
        }
        
        .btn-success {
            background: linear-gradient(45deg, #56ab2f, #a8e6cf);
            color: white;
        }
        
        .btn-info {
            background: linear-gradient(45deg, #0084ff, #00a8ff);
            color: white;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 15px rgba(0,0,0,0.2);
        }
        
        .output-section {
            background: #f1f3f4;
            padding: 20px;
            border-radius: 12px;
        }
        
        .output-text {
    background: white;
    padding: 15px;
    border-radius: 8px;
    font-family: monospace;
    white-space: pre-wrap;
    border: 1px solid #ddd;
    min-height: 200px;
    font-size: 0.95rem;  /* üî• AUMENTADO DE 0.85rem A 0.95rem */
    line-height: 1.4;
}
        
        .checkbox-container {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 10px 0;
        }
        
        .checkbox-container input[type="checkbox"] {
            width: 18px;
            height: 18px;
        }
        
        .status {
            padding: 10px 15px;
            border-radius: 8px;
            margin: 10px 0;
            font-weight: 600;
            font-size: 0.9rem;
        }
        
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>‚ö° Trading R√°pido</h1>
            <p>Formulario de √≥rdenes para day trading - Layout optimizado</p>
        </div>
        
        <div class="form-section">
            <!-- COLUMNA IZQUIERDA: FORMULARIO -->
            <div class="column-left">
                
                <!-- Configuraci√≥n B√°sica -->
                <div>
                    <div class="section-title">
                        üí∞ Configuraci√≥n B√°sica
                    </div>
                    
                    <div class="form-grid">
                        <div class="form-group">
                            <label>üí∞ Riesgo ($)</label>
                            <input type="number" id="riesgo" value="100" min="1">
                        </div>
                        <div class="form-group">
                            <label>üéØ S√≠mbolo</label>
                            <input type="text" id="simbolo" value="btc" placeholder="btc, eth, sol, etc...">
                        </div>
                        <div class="form-group">
                            <label>üìä Tipo</label>
                            <select id="tipo">
                                <option value="LONG">LONG</option>
                                <option value="SHORT">SHORT</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-grid">
                        <div class="form-group">
                            <label>üõ°Ô∏è Stop Loss</label>
                            <input type="number" id="sl" value="58000" step="0.01">
                        </div>
                        <div class="form-group">
                            <label>üí∞ Take Profit</label>
                            <input type="number" id="tp" value="62000" step="0.01">
                        </div>
                    </div>
                </div>
                
                <!-- Entradas Normales -->
                <div>
                    <div class="section-title">
                        üìà Entradas Normales
                    </div>
                    
                    <div class="entradas-container">
                        <div class="entrada-item">
                            <div class="form-group">
                                <label>Entrada 1 - Precio</label>
                                <input type="number" id="entrada1_precio" value="61000" step="0.01">
                            </div>
                            <div class="form-group">
                                <label>% Riesgo</label>
                                <input type="number" id="entrada1_pct" value="15" min="0" max="100">
                            </div>
                        </div>
                        
                        <div class="entrada-item">
                            <div class="form-group">
                                <label>Entrada 2 - Precio</label>
                                <input type="number" id="entrada2_precio" step="0.01">
                            </div>
                            <div class="form-group">
                                <label>% Riesgo</label>
                                <input type="number" id="entrada2_pct" value="0" min="0" max="100">
                            </div>
                        </div>
                        
                        <div class="entrada-item">
                            <div class="form-group">
                                <label>Entrada 3 - Precio</label>
                                <input type="number" id="entrada3_precio" step="0.01">
                            </div>
                            <div class="form-group">
                                <label>% Riesgo</label>
                                <input type="number" id="entrada3_pct" value="0" min="0" max="100">
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- √ìrdenes Escalonadas #1 -->
                <div>
                    <div class="section-title">
                        üìä √ìrdenes Escalonadas #1
                    </div>
                    
                    <div class="escalada-container">
                        <div class="checkbox-container">
                            <input type="checkbox" id="escalada_activa">
                            <label for="escalada_activa">Activar Primer Rango Escalonado</label>
                        </div>
                        
                        <div class="escalada-grid">
                            <div class="form-group">
                                <label>Precio Desde</label>
                                <input type="number" id="escalada_desde" value="59500" step="0.01">
                            </div>
                            <div class="form-group">
                                <label>Precio Hasta</label>
                                <input type="number" id="escalada_hasta" value="58500" step="0.01">
                            </div>
                        </div>
                        
                        <div class="escalada-grid-bottom">
                            <div class="form-group">
                                <label>√ìrdenes</label>
                                <input type="number" id="escalada_ordenes" value="20" min="2" max="50">
                            </div>
                            <div class="form-group">
                                <label>% Riesgo</label>
                                <input type="number" id="escalada_pct" value="85" min="0" max="100">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- √ìrdenes Escalonadas #2 -->
                <div>
                    <div class="section-title">
                        üìä √ìrdenes Escalonadas #2
                    </div>
                    
                    <div class="escalada-container">
                        <div class="checkbox-container">
                            <input type="checkbox" id="escalada2_activa">
                            <label for="escalada2_activa">Activar Segundo Rango Escalonado</label>
                        </div>
                        
                        <div class="escalada-grid">
                            <div class="form-group">
                                <label>Precio Desde</label>
                                <input type="number" id="escalada2_desde" value="58000" step="0.01">
                            </div>
                            <div class="form-group">
                                <label>Precio Hasta</label>
                                <input type="number" id="escalada2_hasta" value="57000" step="0.01">
                            </div>
                        </div>
                        
                        <div class="escalada-grid-bottom">
                            <div class="form-group">
                                <label>√ìrdenes</label>
                                <input type="number" id="escalada2_ordenes" value="10" min="2" max="50">
                            </div>
                            <div class="form-group">
                                <label>% Riesgo</label>
                                <input type="number" id="escalada2_pct" value="0" min="0" max="100">
                            </div>
                        </div>
                    </div>
                </div>
                
            </div>
            
            <!-- COLUMNA DERECHA: PARSER Y RESULTADOS -->
            <div class="column-right">
                
                <!-- Parser de Se√±ales -->
                <div>
                    <div class="section-title">
                        üîÑ Pegar Se√±al Existente
                    </div>
                    
                    <div class="parser-section">
                        <label>Pega aqu√≠ una se√±al para editarla:</label>
                        <textarea id="parser_input" class="parser-textarea" placeholder="Pega aqu√≠ la se√±al de tu bot...&#10;üìä NUEVA ORDEN CALCULADA&#10;üîπ btc&#10;Tipo: LONG&#10;..."></textarea>
                        <button class="btn btn-info" onclick="parsearSenal()">üîÑ Cargar Datos</button>
                    </div>
                </div>
                
                <!-- Botones de Acci√≥n -->
                <div>
                    <div class="section-title">
                        ‚ö° Acciones
                    </div>
                    
                    <div class="buttons-container">
                        <button class="btn btn-primary" onclick="calcular()">üßÆ Calcular</button>
                        <button class="btn btn-secondary" onclick="copiarOutput()">üìã Copiar</button>
                        <button class="btn btn-success" onclick="enviarTelegram()">üì§ Enviar Bot</button>
                        <button class="btn btn-info" onclick="limpiarForm()">üóëÔ∏è Limpiar</button>
                    </div>
                </div>
                
                <!-- üÜï BOTONES DE ENV√çO R√ÅPIDO -->
                <div>
                    <div class="section-title">
                        ‚ö° Env√≠o R√°pido con Shortcuts
                    </div>
                    
                    <div class="buttons-container">
                        <button class="btn btn-success" onclick="enviarScale()">ü™ú Enviar SCALE</button>
                        <button class="btn btn-info" onclick="enviarMarket()">‚ö° Enviar MARKET</button>
                        <button class="btn btn-secondary" onclick="enviarEntradas()">üéØ Enviar ENTRADAS</button>
                        <button class="btn btn-primary" onclick="enviarShortcuts()">üöÄ Ver Shortcuts</button>
                    </div>
                </div>
                
                <!-- Output -->
                <div>
                    <div class="section-title">
                        üöÄ Se√±al Generada
                    </div>
                    
                    <div class="output-section">
                        <div id="output" class="output-text">
                            Click "Calcular" para generar la se√±al...
                        </div>
                    </div>
                </div>
                
                <div id="status"></div>
                
            </div>
        </div>
    </div>

    <script>
        // üß† FUNCI√ìN DE DISTRIBUCI√ìN INTELIGENTE PARA TODAS LAS CRYPTOS
        function distribuirCantidadesInteligente(totalLotes, numOrdenes, tipoOperacion) {
            let pesos;
            
            if (tipoOperacion === 'LONG') {
                // COMPRAS: M√°s lotes ABAJO (mejores precios para cualquier crypto)
                if (numOrdenes <= 5) {
                    pesos = [8, 12, 20, 30, 30];
                } else if (numOrdenes <= 10) {
                    pesos = [3, 4, 5, 7, 10, 15, 20, 16, 12, 8];
                } else if (numOrdenes <= 15) {
                    pesos = [2, 3, 4, 5, 6, 7, 8, 10, 12, 14, 16, 14, 12, 10, 7];
                } else if (numOrdenes <= 20) {
                    pesos = [1, 1, 2, 2, 3, 4, 5, 6, 8, 10, 12, 14, 12, 10, 8, 6, 5, 4, 3, 2];
                } else {
                    // Para m√°s de 20 √≥rdenes, generar patr√≥n piramidal
                    pesos = [];
                    for (let i = 0; i < numOrdenes; i++) {
                        const peso = 1 + (i * 2); // M√°s peso hacia el final (precios m√°s bajos)
                        pesos.push(peso);
                    }
                }
            } else {
                // VENTAS/SHORTS: M√°s lotes ARRIBA (mejores precios para vender)
                if (numOrdenes <= 5) {
                    pesos = [30, 30, 20, 12, 8];
                } else if (numOrdenes <= 10) {
                    pesos = [8, 12, 16, 20, 15, 10, 7, 5, 4, 3];
                } else if (numOrdenes <= 15) {
                    pesos = [7, 10, 12, 14, 16, 14, 12, 10, 8, 7, 6, 5, 4, 3, 2];
                } else if (numOrdenes <= 20) {
                    pesos = [2, 3, 4, 5, 6, 8, 10, 12, 14, 12, 10, 8, 6, 5, 4, 3, 2, 2, 1, 1];
                } else {
                    // Para m√°s de 20 √≥rdenes, generar patr√≥n piramidal invertido
                    pesos = [];
                    for (let i = 0; i < numOrdenes; i++) {
                        const peso = numOrdenes - i; // M√°s peso al inicio (precios m√°s altos)
                        pesos.push(peso);
                    }
                }
            }
            
            // Ajustar array si tiene diferente longitud
            if (pesos.length !== numOrdenes) {
                const ratio = numOrdenes / pesos.length;
                const nuevoPesos = [];
                for (let i = 0; i < numOrdenes; i++) {
                    const index = Math.floor(i / ratio);
                    nuevoPesos.push(pesos[Math.min(index, pesos.length - 1)]);
                }
                pesos = nuevoPesos;
            }
            
            // Normalizar pesos a porcentajes
            const totalPeso = pesos.reduce((sum, peso) => sum + peso, 0);
            const porcentajes = pesos.map(peso => peso / totalPeso);
            
            // Calcular cantidades
            const cantidades = porcentajes.map(pct => totalLotes * pct);
            
            return cantidades;
        }

        // üß† FUNCI√ìN PARA CALCULAR PRECIO PROMEDIO PONDERADO PRECISO
        function calcularPrecioPromedioPonderado(escalonada) {
            if (!escalonada || !escalonada.cantidadesInteligentes) {
                return (escalonada.desde + escalonada.hasta) / 2;
            }
            
            const step = Math.abs(escalonada.hasta - escalonada.desde) / (escalonada.ordenes - 1);
            let nocionalTotal = 0;
            let lotesTotal = 0;
            
            for (let i = 0; i < escalonada.ordenes; i++) {
                const precio = escalonada.desde > escalonada.hasta ? 
                              escalonada.desde - (step * i) : 
                              escalonada.desde + (step * i);
                const cantidad = escalonada.cantidadesInteligentes[i];
                
                nocionalTotal += precio * cantidad;
                lotesTotal += cantidad;
            }
            
            return nocionalTotal / lotesTotal;
        }

        function calcular() {
            const riesgo = parseFloat(document.getElementById('riesgo').value) || 100;
            const simbolo = document.getElementById('simbolo').value;
            const tipo = document.getElementById('tipo').value;
            const sl = parseFloat(document.getElementById('sl').value);
            const tp = parseFloat(document.getElementById('tp').value);
            
            // Entradas normales
            const entradas = [];
            for (let i = 1; i <= 3; i++) {
                const precio = parseFloat(document.getElementById(`entrada${i}_precio`).value);
                const pct = parseFloat(document.getElementById(`entrada${i}_pct`).value) || 0;
                if (precio && pct > 0) {
                    const lotes = (riesgo * (pct/100)) / Math.abs(precio - sl);
                    entradas.push({
                        precio: precio,
                        pct: pct,
                        lotes: lotes.toFixed(6)
                    });
                }
            }
            
            // Escalonada #1
           // Escalonada #1
let escalonada1 = null;
if (document.getElementById('escalada_activa').checked) {
    const desde = parseFloat(document.getElementById('escalada_desde').value);
    const hasta = parseFloat(document.getElementById('escalada_hasta').value);
    const ordenes = parseInt(document.getElementById('escalada_ordenes').value);
    const pct = parseFloat(document.getElementById('escalada_pct').value) || 0;
    
    if (desde && hasta && ordenes && pct > 0) {
        const precioPromedio = (desde + hasta) / 2;
        const lotesTotal = (riesgo * (pct/100)) / Math.abs(precioPromedio - sl);
        
        // üß† USAR DISTRIBUCI√ìN INTELIGENTE
        const cantidadesInteligentes1 = distribuirCantidadesInteligente(lotesTotal, ordenes, tipo);
        
        escalonada1 = {
            desde: desde,
            hasta: hasta,
            ordenes: ordenes,
            pct: pct,
            lotes: lotesTotal.toFixed(6),
            nombre: "Escalonada 1",
            cantidadesInteligentes: cantidadesInteligentes1
        };
    }
}

// Escalonada #2
let escalonada2 = null;
if (document.getElementById('escalada2_activa').checked) {
    const desde = parseFloat(document.getElementById('escalada2_desde').value);
    const hasta = parseFloat(document.getElementById('escalada2_hasta').value);
    const ordenes = parseInt(document.getElementById('escalada2_ordenes').value);
    const pct = parseFloat(document.getElementById('escalada2_pct').value) || 0;
    
    if (desde && hasta && ordenes && pct > 0) {
        const precioPromedio = (desde + hasta) / 2;
        const lotesTotal = (riesgo * (pct/100)) / Math.abs(precioPromedio - sl);
        
        // üß† USAR DISTRIBUCI√ìN INTELIGENTE
        const cantidadesInteligentes2 = distribuirCantidadesInteligente(lotesTotal, ordenes, tipo);
        
        escalonada2 = {
            desde: desde,
            hasta: hasta,
            ordenes: ordenes,
            pct: pct,
            lotes: lotesTotal.toFixed(6),
            nombre: "Escalonada 2",
            cantidadesInteligentes: cantidadesInteligentes2
        };
    }
}

// C√°lculos finales
let lotesTotales = entradas.reduce((sum, e) => sum + parseFloat(e.lotes), 0);
if (escalonada1) lotesTotales += parseFloat(escalonada1.lotes);
if (escalonada2) lotesTotales += parseFloat(escalonada2.lotes);

const pctTotal = entradas.reduce((sum, e) => sum + e.pct, 0) + 
                 (escalonada1 ? escalonada1.pct : 0) + 
                 (escalonada2 ? escalonada2.pct : 0);

// üß† Precio promedio ponderado PRECISO con distribuci√≥n inteligente
let nocionalTotal = entradas.reduce((sum, e) => sum + (e.precio * parseFloat(e.lotes)), 0);
if (escalonada1) {
    const precioPromedio1 = calcularPrecioPromedioPonderado(escalonada1);
    nocionalTotal += precioPromedio1 * parseFloat(escalonada1.lotes);
}
if (escalonada2) {
    const precioPromedio2 = calcularPrecioPromedioPonderado(escalonada2);
    nocionalTotal += precioPromedio2 * parseFloat(escalonada2.lotes);
}
const precioPromedio = nocionalTotal / lotesTotales;

const perdidaSL = Math.abs(sl - precioPromedio) * lotesTotales;
const gananciaTP = Math.abs(tp - precioPromedio) * lotesTotales;
const rr = gananciaTP / perdidaSL;

// Generar output
let output = `üìä NUEVA ORDEN CALCULADA

üîπ ${simbolo}

Tipo: ${tipo}
Riesgo: $${riesgo}

Entradas:`;

            entradas.forEach(e => {
                output += `\n- ${e.precio} (${e.pct}%) ‚Üí ${e.lotes} lotes`;
            });
            
            if (escalonada1) {
                output += `\n- ${escalonada1.nombre} (${escalonada1.pct}%): ${escalonada1.desde} a ${escalonada1.hasta} con ${escalonada1.ordenes} √≥rdenes ‚Üí ${escalonada1.lotes} lotes`;
            }

            if (escalonada2) {
                output += `\n- ${escalonada2.nombre} (${escalonada2.pct}%): ${escalonada2.desde} a ${escalonada2.hasta} con ${escalonada2.ordenes} √≥rdenes ‚Üí ${escalonada2.lotes} lotes`;
            }
            
            output += `

Precio Promedio: ${precioPromedio.toFixed(2)}
SL: ${sl} (P√©rdida: ${perdidaSL.toFixed(2)})
TP: ${tp} (Ganancia: ${gananciaTP.toFixed(2)})

Lotes Totales: ${lotesTotales.toFixed(6)}
R/B: ${rr.toFixed(3)}

${Math.abs(perdidaSL - riesgo) < 1 ? '‚úÖ RIESGO EXACTO' : '‚ö†Ô∏è PORCENTAJES: ' + pctTotal + '% (debe ser 100%)'}`;
            
            document.getElementById('output').textContent = output;
            
            showStatus(pctTotal === 100 ? 'success' : 'error', 
                     pctTotal === 100 ? '‚úÖ C√°lculo completado correctamente' : `‚ö†Ô∏è Los porcentajes suman ${pctTotal}% (debe ser 100%)`);
        }
        
        function parsearSenal() {
            const input = document.getElementById('parser_input').value;
            if (!input) return;
            
            try {
                // Limpiar entradas previas
                for (let i = 1; i <= 3; i++) {
                    document.getElementById(`entrada${i}_precio`).value = '';
                    document.getElementById(`entrada${i}_pct`).value = '0';
                }
                document.getElementById('escalada_activa').checked = false;
                document.getElementById('escalada2_activa').checked = false;
                
                // DETECTAR FORMATO Y EXTRAER DATOS - VERSI√ìN ULTRA FLEXIBLE
                
                // 1. Extraer s√≠mbolo (m√°xima flexibilidad)
                const simboloPatterns = [
                    /üîπ\s*(\w+)/i,
                    /s√≠mbolo[:\s]*(\w+)/i,
                    /symbol[:\s]*(\w+)/i,
                    /par[:\s]*(\w+)/i,
                    /^(\w+)\s*(?:long|short)/i,
                    /^([a-z]{2,5})$/im,  // Solo s√≠mbolo en l√≠nea (btc, eth, etc)
                    /(\w+USDT)/i
                ];
                
                for (const pattern of simboloPatterns) {
                    const match = input.match(pattern);
                    if (match) {
                        document.getElementById('simbolo').value = match[1].toLowerCase();
                        break;
                    }
                }
                
                // 2. Extraer tipo (m√°xima flexibilidad)
                const tipoPatterns = [
                    /tipo[:\s]*(long|short)/i,
                    /direcci√≥n[:\s]*(long|short)/i,
                    /direction[:\s]*(long|short)/i,
                    /^(long|short)$/im,  // Solo en una l√≠nea
                    /(long|short)/i
                ];
                
                for (const pattern of tipoPatterns) {
                    const match = input.match(pattern);
                    if (match) {
                        document.getElementById('tipo').value = match[1].toUpperCase();
                        break;
                    }
                }
                
                // 3. Extraer riesgo (m√°xima flexibilidad)
                const riesgoPatterns = [
                    /riesgo[:\s]*\$?(\d+(?:\.\d+)?)/i,
                    /risk[:\s]*\$?(\d+(?:\.\d+)?)/i,
                    /capital[:\s]*\$?(\d+(?:\.\d+)?)/i,
                    /(\d+)\$?\s*riesgo/i,  // "100$ riesgo" o "100 riesgo"
                    /\$(\d+(?:\.\d+)?)/
                ];
                
                for (const pattern of riesgoPatterns) {
                    const match = input.match(pattern);
                    if (match) {
                        document.getElementById('riesgo').value = match[1];
                        break;
                    }
                }
                
                // 4. Extraer Stop Loss (m√°xima flexibilidad)
                const slPatterns = [
                    /sl[:\s]*(\d+(?:\.\d+)?)/i,
                    /stop\s*loss[:\s]*(\d+(?:\.\d+)?)/i,
                    /stop[:\s]*(\d+(?:\.\d+)?)/i,
                    /stoploss[:\s]*(\d+(?:\.\d+)?)/i
                ];
                
                for (const pattern of slPatterns) {
                    const match = input.match(pattern);
                    if (match) {
                        document.getElementById('sl').value = match[1];
                        break;
                    }
                }
                
                // 5. Extraer Take Profit (m√°xima flexibilidad)
                const tpPatterns = [
                    /tp[:\s]*(\d+(?:\.\d+)?)/i,
                    /take\s*profit[:\s]*(\d+(?:\.\d+)?)/i,
                    /target[:\s]*(\d+(?:\.\d+)?)/i,
                    /objetivo[:\s]*(\d+(?:\.\d+)?)/i
                ];
                
                for (const pattern of tpPatterns) {
                    const match = input.match(pattern);
                    if (match) {
                        document.getElementById('tp').value = match[1];
                        break;
                    }
                }
                
                // 6. Extraer entradas (m√°xima flexibilidad)
                const entradaPatterns = [
                    // Formato tradicional: "Entrada 1: 105,900 (25%)"
                    /entrada\s*(\d)[:\s]*(\d+(?:,\d{3})*(?:\.\d+)?)\s*\((\d+)%\)/gi,
                    // Tu formato: "entrada: 1 106090.9 30%"
                    /entrada[:\s]*(\d)\s*(\d+(?:,\d{3})*(?:\.\d+)?)\s*(\d+)%/gi,
                    // Formato: "Entry 1: 105900 25%"
                    /entry\s*(\d)[:\s]*(\d+(?:,\d{3})*(?:\.\d+)?)\s*(\d+)%/gi,
                    // Formato: "- 105900 (25%)"
                    /-\s*(\d+(?:,\d{3})*(?:\.\d+)?)\s*\((\d+)%\)/g,
                    // Formato simple: "105900 25%"
                    /(\d+(?:,\d{3})*(?:\.\d+)?)\s*(\d+)%/g
                ];
                
                let entradaIndex = 1;
                for (const pattern of entradaPatterns) {
                    const matches = [...input.matchAll(pattern)];
                    for (const match of matches) {
                        if (entradaIndex <= 3) {
                            let precio, pct;
                            if (match.length === 4) { // Con n√∫mero de entrada
                                precio = match[2].replace(/,/g, '');
                                pct = match[3];
                            } else { // Sin n√∫mero de entrada
                                precio = match[1].replace(/,/g, '');
                                pct = match[2];
                            }
                            
                            document.getElementById(`entrada${entradaIndex}_precio`).value = precio;
                           document.getElementById(`entrada${entradaIndex}_pct`).value = pct;
                           entradaIndex++;
                       }
                   }
                   if (entradaIndex > 1) break; // Si encontr√≥ entradas, no buscar m√°s
               }
               
               // 7. Extraer escaladas (m√°xima flexibilidad) - MEJORADO PARA 2 RANGOS
              const escaladaPatterns = [
                  // Formato tradicional: "Escalada: 104,800 a 104,400 con 8-10 √≥rdenes (40%)"
                  /(?:escalada|rango\s*\d*)[:\s]*(\d+(?:,\d{3})*(?:\.\d+)?)\s*a\s*(\d+(?:,\d{3})*(?:\.\d+)?)\s*con\s*(\d+)(?:-\d+)?\s*√≥rdenes\s*\((\d+)%\)/gi,
                  // Tu formato: "escalada: 105670.8 a 104526.5 con 15 ordenes 30%"
                  /(?:escalada|rango\s*\d*)[:\s]*(\d+(?:,\d{3})*(?:\.\d+)?)\s*a\s*(\d+(?:,\d{3})*(?:\.\d+)?)\s*con\s*(\d+)\s*ordenes\s*(\d+)%/gi,
                  // Formato: "Scale: 104800 to 104400 with 8 orders 40%"
                  /(?:scale|rango\s*\d*)[:\s]*(\d+(?:,\d{3})*(?:\.\d+)?)\s*(?:to|a)\s*(\d+(?:,\d{3})*(?:\.\d+)?)\s*(?:with|con)\s*(\d+)\s*(?:orders|√≥rdenes|ordenes)[:\s]*(\d+)%/gi
              ];
              
              let escaladaIndex = 1;
              for (const pattern of escaladaPatterns) {
                  const matches = [...input.matchAll(pattern)];
                  for (const match of matches) {
                      if (escaladaIndex <= 2) {
                          const fieldPrefix = escaladaIndex === 1 ? 'escalada' : 'escalada2';
                          
                          document.getElementById(`${fieldPrefix}_activa`).checked = true;
                          document.getElementById(`${fieldPrefix}_desde`).value = match[1].replace(/,/g, '');
                          document.getElementById(`${fieldPrefix}_hasta`).value = match[2].replace(/,/g, '');
                          document.getElementById(`${fieldPrefix}_ordenes`).value = match[3];
                          document.getElementById(`${fieldPrefix}_pct`).value = match[4];
                          escaladaIndex++;
                      }
                  }
              }
              
              showStatus('success', '‚úÖ Se√±al cargada - Parser mejorado con 2 rangos');
              calcular(); // Auto-calcular despu√©s de cargar
              
          } catch (error) {
              showStatus('error', '‚ùå Error al parsear - Revisa el formato');
              console.log('Parser error:', error);
          }
      }
      
      function copiarOutput() {
          const output = document.getElementById('output').textContent;
          navigator.clipboard.writeText(output).then(() => {
              showStatus('success', '‚úÖ Copiado al portapapeles');
          });
      }
      
      function enviarTelegram() {
          const output = document.getElementById('output').textContent;
          
          // Pon aqu√≠ tu bot token y chat ID
          const botToken = "7582987755:AAFBdNQFZ4McMsJwt60gvTs9CW2XkKZ3OMA";
          const chatId = "7471012566";
          
          const url = `https://api.telegram.org/bot${botToken}/sendMessage`;
          
          fetch(url, {
              method: 'POST',
              headers: {
                  'Content-Type': 'application/json',
              },
              body: JSON.stringify({
                  chat_id: chatId,
                  text: output
              })
          })
          .then(response => response.json())
          .then(data => {
              if (data.ok) {
                  showStatus('success', '‚úÖ Enviado a Telegram!');
              } else {
                  showStatus('error', '‚ùå Error al enviar');
              }
          })
          .catch(error => {
              showStatus('error', '‚ùå Error de conexi√≥n');
          });
      }

      // üÜï FUNCIONES DE ENV√çO R√ÅPIDO CON SHORTCUTS

      function enviarScale() {
    const simbolo = document.getElementById('simbolo').value || 'btc';
    const tipo = document.getElementById('tipo').value;
    const sl = document.getElementById('sl').value;
    const tp = document.getElementById('tp').value;
    
    let comandosEnviados = 0;
    
    // üî• ENVIAR ESCALADA #1 SI EST√Å ACTIVA
    if (document.getElementById('escalada_activa').checked) {
        const desde1 = document.getElementById('escalada_desde').value;
        const hasta1 = document.getElementById('escalada_hasta').value;
        const ordenes1 = document.getElementById('escalada_ordenes').value;
        const pct1 = parseFloat(document.getElementById('escalada_pct').value) || 0;
        const riesgo = parseFloat(document.getElementById('riesgo').value) || 100;
        
        if (desde1 && hasta1 && ordenes1 && pct1 > 0) {
            // Calcular cantidad aproximada
            const precioPromedio1 = (parseFloat(desde1) + parseFloat(hasta1)) / 2;
            const lotesAprox1 = (riesgo * (pct1/100)) / Math.abs(precioPromedio1 - parseFloat(sl));
            
            // üî• USAR SHORTCUT 'sb' o 'ss'
            const shortcut = tipo === 'LONG' ? 'sb' : 'ss';
            const comando1 = `${shortcut} ${simbolo} ${lotesAprox1.toFixed(3)} ${desde1}-${hasta1} ${ordenes1}${sl ? ' SL:' + sl : ''}${tp ? ' TP:' + tp : ''}`;
            
            enviarComandoTelegram(comando1, 'SCALE #1');
            comandosEnviados++;
        }
    }
    
    // üî• ENVIAR ESCALADA #2 SI EST√Å ACTIVA
    if (document.getElementById('escalada2_activa').checked) {
        const desde2 = document.getElementById('escalada2_desde').value;
        const hasta2 = document.getElementById('escalada2_hasta').value;
        const ordenes2 = document.getElementById('escalada2_ordenes').value;
        const pct2 = parseFloat(document.getElementById('escalada2_pct').value) || 0;
        const riesgo = parseFloat(document.getElementById('riesgo').value) || 100;
        
        if (desde2 && hasta2 && ordenes2 && pct2 > 0) {
            // Calcular cantidad aproximada
            const precioPromedio2 = (parseFloat(desde2) + parseFloat(hasta2)) / 2;
            const lotesAprox2 = (riesgo * (pct2/100)) / Math.abs(precioPromedio2 - parseFloat(sl));
            
            // üî• USAR SHORTCUT 'sb' o 'ss'
            const shortcut = tipo === 'LONG' ? 'sb' : 'ss';
            const comando2 = `${shortcut} ${simbolo} ${lotesAprox2.toFixed(3)} ${desde2}-${hasta2} ${ordenes2}${sl ? ' SL:' + sl : ''}${tp ? ' TP:' + tp : ''}`;
            
            // üÜï ESPERAR UN POCO ENTRE ENV√çOS PARA NO SATURAR
            setTimeout(() => {
                enviarComandoTelegram(comando2, 'SCALE #2');
            }, 1000);
            comandosEnviados++;
        }
    }
    
    // Mostrar mensaje de error si no hay escaladas activas
    if (comandosEnviados === 0) {
        showStatus('error', '‚ùå Activa al menos una escalada para enviar SCALE');
    } else {
        showStatus('success', `‚úÖ Enviando ${comandosEnviados} comando(s) SCALE`);
    }
}

function enviarMarket() {
    const simbolo = document.getElementById('simbolo').value || 'btc';
    const tipo = document.getElementById('tipo').value;
    const sl = document.getElementById('sl').value; // üî• INCLUIR SL
    const tp = document.getElementById('tp').value; // üî• INCLUIR TP OPCIONAL
    
    // Buscar primera entrada con cantidad
    let cantidadEncontrada = false;
    for (let i = 1; i <= 3; i++) {
        const precio = document.getElementById(`entrada${i}_precio`).value;
        const pct = parseFloat(document.getElementById(`entrada${i}_pct`).value) || 0;
        
        if (precio && pct > 0) {
            const riesgo = parseFloat(document.getElementById('riesgo').value) || 100;
            const lotes = (riesgo * (pct/100)) / Math.abs(precio - sl);
            
            // üî• USAR SHORTCUT 'mb' o 'ms' CON SL/TP
            const shortcut = tipo === 'LONG' ? 'mb' : 'ms';
            let comando = `${shortcut} ${simbolo} ${lotes.toFixed(3)}`;
            
            // üÜï A√ëADIR SL Y TP AL COMANDO MARKET
            if (sl) {
                comando += ` SL:${sl}`;
            }
            if (tp) {
                comando += ` TP:${tp}`;
            }
            
            enviarComandoTelegram(comando, 'MARKET CON SL/TP');
            cantidadEncontrada = true;
            break;
        }
    }
    
    if (!cantidadEncontrada) {
        // Cantidad por defecto si no hay entradas
        const shortcut = tipo === 'LONG' ? 'mb' : 'ms';
        let comando = `${shortcut} ${simbolo} 0.005`;
        
        // üÜï A√ëADIR SL Y TP INCLUSO EN CANTIDAD POR DEFECTO
        if (sl) {
            comando += ` SL:${sl}`;
        }
        if (tp) {
            comando += ` TP:${tp}`;
        }
        
        enviarComandoTelegram(comando, 'MARKET CON SL/TP');
    }
}

      function enviarEntradas() {
          const simbolo = document.getElementById('simbolo').value || 'btc';
          const tipo = document.getElementById('tipo').value;
          const sl = document.getElementById('sl').value;
          const tp = document.getElementById('tp').value;
          
          // Buscar primera entrada v√°lida
          for (let i = 1; i <= 3; i++) {
              const precio = document.getElementById(`entrada${i}_precio`).value;
              const pct = parseFloat(document.getElementById(`entrada${i}_pct`).value) || 0;
              
              if (precio && pct > 0) {
                  const riesgo = parseFloat(document.getElementById('riesgo').value) || 100;
                  const lotes = (riesgo * (pct/100)) / Math.abs(precio - sl);
                  
                  // üî• USAR SHORTCUT 'lb' o 'ls' (Limit Buy/Sell)
                  const shortcut = tipo === 'LONG' ? 'lb' : 'ls';
                  const comando = `${shortcut} ${simbolo} ${lotes.toFixed(3)} ${precio}${sl ? ' SL:' + sl : ''}${tp ? ' TP:' + tp : ''}`;
                  
                  enviarComandoTelegram(comando, 'ENTRADA LIMIT');
                  break;
              }
          }
      }

      function enviarShortcuts() {
          const simbolo = document.getElementById('simbolo').value || 'btc';
          
          const shortcuts = `‚ö° SHORTCUTS DISPONIBLES:

üî• MARKET ORDERS:
- mb ${simbolo} 0.005  (Market Buy)
- ms ${simbolo} 0.1    (Market Sell)

üéØ LIMIT ORDERS:
- lb ${simbolo} 0.005 45000  (Limit Buy)
- ls ${simbolo} 0.1 3500     (Limit Sell)

ü™ú SCALE ORDERS:
- sb ${simbolo} 0.015 61500-58500 10 SL:58000
- ss ${simbolo} 2 150-140 20 TP:160

‚ö° COMANDOS:
- b    (Balance)
- p    (Posiciones)
- o    (√ìrdenes)
- close ${simbolo}  (Cerrar posici√≥n)

üí° Solo env√≠a el comando que necesites!`;

          enviarComandoTelegram(shortcuts, 'SHORTCUTS');
      }

      function enviarComandoTelegram(comando, tipo) {
          const botToken = "7582987755:AAFBdNQFZ4McMsJwt60gvTs9CW2XkKZ3OMA";
          const chatId = "7471012566";
          
          const url = `https://api.telegram.org/bot${botToken}/sendMessage`;
          
          fetch(url, {
              method: 'POST',
              headers: {
                  'Content-Type': 'application/json',
              },
              body: JSON.stringify({
                  chat_id: chatId,
                  text: comando
              })
          })
          .then(response => response.json())
          .then(data => {
              if (data.ok) {
                  showStatus('success', `‚úÖ ${tipo} enviado: ${comando.substring(0, 30)}...`);
              } else {
                  showStatus('error', `‚ùå Error al enviar ${tipo}`);
              }
          })
          .catch(error => {
              showStatus('error', `‚ùå Error de conexi√≥n al enviar ${tipo}`);
          });
      }
      
      function limpiarForm() {
          // MANTENER SOLO EL RIESGO - limpiar todo lo dem√°s
          
          // Configuraci√≥n b√°sica - limpiar todo excepto riesgo
          document.getElementById('simbolo').value = '';
          document.getElementById('tipo').selectedIndex = 0; // LONG
          document.getElementById('sl').value = '';
          document.getElementById('tp').value = '';
          
          // Limpiar TODAS las entradas completamente
          for (let i = 1; i <= 3; i++) {
              document.getElementById(`entrada${i}_precio`).value = '';
              document.getElementById(`entrada${i}_pct`).value = '';
          }
          
          // Limpiar escalada 1 completamente
          document.getElementById('escalada_activa').checked = false;
          document.getElementById('escalada_desde').value = '';
          document.getElementById('escalada_hasta').value = '';
          document.getElementById('escalada_ordenes').value = '';
          document.getElementById('escalada_pct').value = '';
          
          // Limpiar escalada 2 completamente
          document.getElementById('escalada2_activa').checked = false;
          document.getElementById('escalada2_desde').value = '';
          document.getElementById('escalada2_hasta').value = '';
          document.getElementById('escalada2_ordenes').value = '';
          document.getElementById('escalada2_pct').value = '';
          
          // Limpiar parser y output
          document.getElementById('parser_input').value = '';
          document.getElementById('output').textContent = 'Click "Calcular" para generar la se√±al...';
          
          // Limpiar status
          const statusEl = document.getElementById('status');
          statusEl.textContent = '';
          statusEl.className = '';
          
          showStatus('success', '‚úÖ Formulario limpiado - Riesgo mantenido');
      }
      
      function showStatus(type, message) {
          const status = document.getElementById('status');
          status.className = `status ${type}`;
          status.textContent = message;
          setTimeout(() => {
              status.textContent = '';
              status.className = '';
          }, 3000);
      }
      
      // Auto-calcular cuando cambien valores importantes
      document.addEventListener('DOMContentLoaded', function() {
          const inputs = document.querySelectorAll('input, select');
          inputs.forEach(input => {
              input.addEventListener('change', calcular);
          });
      });
  </script>
</body>
</html>
